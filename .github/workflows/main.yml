name: CI/CD Pipeline

on:
  push:
    branches:
      - development

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'

    - name: Install dependencies
      run: npm install

    - name: Build Docker image
      run: |
        docker build -t quiz .
        docker images

    - name: Log in to Docker Hub
      run: echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

    - name: Tag Docker image with commit SHA
      run: docker tag quiz ${{ secrets.DOCKER_USERNAME }}/quiz:${{ github.sha }}

    - name: Push Docker image to Docker Hub
      run: docker push ${{ secrets.DOCKER_USERNAME }}/quiz:${{ github.sha }}

    - name: Configure AWS CLI
      run: |
        aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws configure set default.region ${{ secrets.AWS_REGION }}

    - name: Get current ECS task definition revision
      id: ecs-task-revision
      run: |
        ecs_task_definition="Task1-chandana-definition"
        echo "::set-output name=revision::$(aws ecs describe-task-definition --task-definition $ecs_task_definition --query 'taskDefinition.revision')"

    - name: Update ECS task definition with new image
      run: |
        ecs_task_definition="Task1-chandana-definition"
        new_image_uri="${{ secrets.DOCKER_USERNAME }}/quiz:${{ github.sha }}"
        current_task_definition=$(aws ecs describe-task-definition --task-definition $ecs_task_definition)
        family=$(echo $current_task_definition | jq -r '.taskDefinition.family')
        container_definitions=$(echo $current_task_definition | jq --arg new_image_uri "$new_image_uri" '.taskDefinition.containerDefinitions[0].image = $new_image_uri' | jq '.taskDefinition.containerDefinitions')
        aws ecs register-task-definition --family $family --container-definitions "$container_definitions" --cli-input-json "$current_task_definition"

    - name: Update ECS service to use the latest task definition
      run: |
        ecs_cluster_name="chandana-devops-task"
        ecs_service_name="chandana-quiz"
        ecs_task_definition="Task1-chandana-definition"
        updated_task_definition=$(aws ecs describe-task-definition --task-definition $ecs_task_definition)
        aws ecs update-service --cluster $ecs_cluster_name --service $ecs_service_name --task-definition $updated_task_definition.taskDefinitionArn --debug
