name: CI/CD Pipeline

on:
  push:
    branches:
      - development

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Build Docker image
      run: |
        docker build -t quiz .
        docker images

    - name: Log in to Docker Hub
      run: echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

    - name: Tag Docker image with commit SHA
      run: docker tag quiz ${{ secrets.DOCKER_USERNAME }}/quiz:${{ github.sha }}

    - name: Push Docker image to Docker Hub
      run: docker push ${{ secrets.DOCKER_USERNAME }}/quiz:${{ github.sha }}

    - name: Get existing ECS task definition
      run: |
        existing_task_definition=$(aws ecs describe-task-definition --task-definition ${{ secrets.ECS_TASK_DEFINITION }} --query 'taskDefinition')

    - name: Update ECS task definition with new image
      run: |
        new_image_uri="${{ secrets.DOCKER_USERNAME }}/quiz:${{ github.sha }}"
        
        # Extract family name from the current task definition
        family_name=$(echo $current_task_definition | jq -r '.taskDefinition.family')
        
        updated_container_definition=$(echo "$existing_task_definition" | jq --arg new_image_uri "$new_image_uri" '.containerDefinitions[0].image = $new_image_uri' -c)

        # Register the updated task definition as a new revision
        updated_task_definition=$(aws ecs register-task-definition --family "$family_name" --container-definitions "$updated_container_definition" --query 'taskDefinition')
        
        # Extract the new revision number
        new_revision=$(echo $updated_task_definition | jq -r '.revision')
        echo "New revision created: $new_revision"

    #- name: Update ECS service to use the latest task definition
    #  run: |
     #   ecs_cluster_name="${{ secrets.ECS_CLUSTER_NAME }}"
      #  ecs_service_name="${{ secrets.ECS_SERVICE_NAME }}"
       # updated_task_definition_arn=$(echo "$updated_task_definition" | jq -r '.taskDefinitionArn')
        # Update service with the new task definition
        #aws ecs update-service --cluster $ecs_cluster_name --service $ecs_service_name --task-definition $updated_task_definition_arn --force-new-deployment
